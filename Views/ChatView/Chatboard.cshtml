@*@{
    ViewData["Title"] = "Chatboard";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Chats</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
            <i class="fas fa-plus me-2"></i>New Chat
        </button>
    </div>

    <div class="input-group mb-3">
        <input id="searchTrader" type="text" class="form-control" placeholder="Search traders...">
    </div>

    <div id="chatList" class="list-group">
        @if (Model != null && Model.Any())
        {
            @foreach (var contact in Model)
            {
                <a asp-controller="ChatView" asp-action="Conversation" asp-route-traderId="@contact.TraderId"
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@contact.TraderName</strong><br />
                        <small class="text-muted">@contact.LastMessageSnippet</small><br>
                        <small class="text-muted">@contact.LastMessageAt.ToString("g")</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">
                        @if (contact.UnreadCount > 0)
                        {
                            @contact.UnreadCount
                        }
                    </span>
                </a>
            }
        }
        else
        {
            <div class="text-center py-4 text-muted">
                No recent conversations found
            </div>
        }
    </div>
</div>*@
<!-- Modal for selecting new chat recipient -->
































@model IEnumerable<TradeSphere3.Models.Dto.ContactDto>
@{
    ViewData["Title"] = "Chatboard";
}

<div class="container py-4">
    <h2 class="mb-4 text-center">Chats</h2>
    
    <div class="alert alert-info mb-3">
        <small class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            When you search, results are shown in priority order: Exact GST match > Exact CIN match > GST prefix match > CIN prefix match > Name match.
        </small>
    </div>
    
    <!-- No Search Message -->
    <div class="alert alert-success mb-3">
        <h5 class="alert-heading"><i class="bi bi-chat-dots me-2"></i>Recent Messages</h5>
        <p class="mb-0">When no search terms are entered, all your recent messages will be displayed in chronological order (most recent first).</p>
    </div>

    @await Html.PartialAsync("_TraderSearchBar")

    <!-- Create Message Button -->
    <div class="mb-3">
        <a href="/ChatView/NewChatList" class="btn btn-outline-primary w-100">
            + Create New Chat
        </a>
    </div>

    <!-- Chat联系人表格 -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>CIN</th>
                <th>GST No</th>
                <th>Email</th>
                <th style="font-size: 1.1rem; font-weight: 600; text-transform: uppercase;">Last Message</th>
                <th style="font-size: 1.1rem; font-weight: 600; text-transform: uppercase; text-align: center;">Unread</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @if (Model == null || !Model.Any())
        {
            <tr>
                <td colspan="7" class="text-center">
                    <i class="bi bi-chat-dots fs-1"></i><br>
                    <p class="mt-3">You haven't started any chats yet.<br />Search a trader to start chatting!</p>
                </td>
            </tr>
        }
        else
        {
            @foreach (var contact in Model)
            {
                <tr class="chat-item"
                    data-name="@contact.TraderName.ToLower()" 
                    data-unread="@contact.UnreadCount"
                    data-date="@contact.LastMessageAt.ToString("yyyy-MM-ddTHH:mm:ss")" 
                    data-message="@contact.LastMessageSnippet.ToLower()">
                    <td>
                        <a asp-controller="ChatView" asp-action="Conversation" asp-route-traderId="@contact.TraderId">
                            <strong>@contact.TraderName</strong>
                        </a>
                        @if (contact.IsOnline)
                        {
                            <i class="bi bi-circle-fill text-success" title="Online"></i>
                        }
                    </td>
                    <td>@contact.CIN</td>
                    <td>@contact.GSTNo</td>
                    <td>@contact.Email</td>
                    <td>
                        <div class="px-2 py-1 bg-light rounded">
                            <small class="text-muted d-block mb-1">Last:</small>
                            <div class="fw-medium">
                                @contact.LastMessageSnippet
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        @if (contact.UnreadCount > 0)
                        {
                            <span class="badge bg-primary rounded-pill">@contact.UnreadCount</span>
                        }
                    </td>
                    <td>
                        <a asp-controller="ChatView" asp-action="Conversation" asp-route-traderId="@contact.TraderId" 
                           class="btn btn-outline-primary btn-sm">Open Chat</a>
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>

    <!-- Modal for selecting new chat recipient -->
    <div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newChatModalLabel">Start New Chat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input id="newChatSearch" type="text" class="form-control mb-3" placeholder="Search traders by name, email...">
                    
                    <!-- Advanced Filters in Modal -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" id="modalCityFilter" class="form-control form-control-sm" placeholder="City" />
                        </div>
                        <div class="col-md-6">
                            <input type="text" id="modalCountryFilter" class="form-control form-control-sm" placeholder="Country" />
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <select id="modalRoleFilter" class="form-select form-select-sm">
                            <option value="">All Roles</option>
                            <option value="Importer">Importer</option>
                            <option value="Exporter">Exporter</option>
                            <option value="Both">Both</option>
                        </select>
                    </div>
                    
                    <div id="newChatResults" class="list-group">
                        <!-- Results will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            // Function to filter chat items
function filterChats() {
            const searchTerm = document.getElementById('name').value.toLowerCase();
                const filterUnread = document.getElementById('filterUnread').checked;
                const filterRecent = document.getElementById('filterRecent').checked;
                const sortBy = document.getElementById('sortByFilter').value;
                
                const chatItems = Array.from(document.querySelectorAll('.chat-item'));
                let anyVisible = false;
                
                // Filter items
                chatItems.forEach(item => {
                    const name = item.dataset.name;
                    const message = item.dataset.message;
                    const unread = parseInt(item.dataset.unread) || 0;
                    const date = new Date(item.dataset.date);
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    
                    const matchesSearch = !searchTerm || name.includes(searchTerm) || message.includes(searchTerm);
                    const matchesUnread = !filterUnread || unread > 0;
                    const matchesRecent = !filterRecent || date >= sevenDaysAgo;
                    
                    const shouldShow = matchesSearch && matchesUnread && matchesRecent;
                    
                    item.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) anyVisible = true;
                });
                
                // Sort items
                const parent = document.getElementById('chatList');
                const visibleItems = chatItems.filter(item => item.style.display !== 'none');
                
                visibleItems.sort((a, b) => {
                    switch(sortBy) {
                        case 'unread':
                            const unreadA = parseInt(a.dataset.unread) || 0;
                            const unreadB = parseInt(b.dataset.unread) || 0;
                            return unreadB - unreadA;
                        case 'name':
                            return a.dataset.name.localeCompare(b.dataset.name);
                        case 'recent':
                        default:
                            const dateA = new Date(a.dataset.date);
                            const dateB = new Date(b.dataset.date);
                            return dateB - dateA;
                    }
                });
                
                // Reorder in DOM
                visibleItems.forEach(item => parent.appendChild(item));
                
                // Show/hide no results message
                const noResultsMsg = document.querySelector('.text-center.text-muted.py-5');
                if (noResultsMsg) {
                    noResultsMsg.style.display = anyVisible || chatItems.length === 0 ? 'none' : '';
                }
            }
            
            // Event listeners
document.getElementById("name").addEventListener("input", filterChats);
            document.getElementById("filterUnread").addEventListener("change", filterChats);
            document.getElementById("filterRecent").addEventListener("change", filterChats);
            document.getElementById("sortByFilter").addEventListener("change", filterChats);
            
document.getElementById("clearChatFiltersBtn").addEventListener('click', function() {
                document.getElementById('name').value = '';
                document.getElementById('filterUnread').checked = false;
                document.getElementById('filterRecent').checked = false;
                document.getElementById('sortByFilter').value = 'recent';
                filterChats();
            });

            // New chat functionality
            const newChatSearch = document.getElementById('newChatSearch');
            const modalCityFilter = document.getElementById('modalCityFilter');
            const modalCountryFilter = document.getElementById('modalCountryFilter');
            const modalRoleFilter = document.getElementById('modalRoleFilter');
            const newChatResults = document.getElementById('newChatResults');
            let debounceTimer;

            function searchNewTraders() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = newChatSearch.value.trim();
                    const city = modalCityFilter.value.trim();
                    const country = modalCountryFilter.value.trim();
                    const role = modalRoleFilter.value;
                    
                    // Build query string
                    const params = new URLSearchParams();
                    if (query) params.append('search', query);
                    if (city) params.append('city', city);
                    if (country) params.append('country', country);
                    if (role) params.append('role', role);
                    
                    const url = `/api/chat/new-traders${params.toString() ? '?' + params.toString() : ''}`;
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            newChatResults.innerHTML = '';
                            if (data.length === 0) {
                                newChatResults.innerHTML = '<div class="text-center text-muted py-3">No traders match your criteria</div>';
                                return;
                            }
                            
                            data.forEach(trader => {
                                const item = document.createElement('a');
                                item.href = `/ChatView/Conversation/${trader.traderId}`;
                                item.className = 'list-group-item list-group-item-action';
                                item.innerHTML = `
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>${trader.name}</strong>
                                            <span class="badge bg-secondary ms-2">${trader.tradeRole || 'N/A'}</span><br>
                                            <small class="text-muted">${trader.email}</small><br>
                                            <small class="text-muted">${trader.city || 'N/A'}, ${trader.country || 'N/A'}</small>
                                        </div>
                                    </div>
                                `;
                                newChatResults.appendChild(item);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading traders:', error);
                            newChatResults.innerHTML = '<div class="text-center text-danger py-3">Error loading traders</div>';
                        });
                }, 300);
            }
            
            // Add event listeners to all inputs
            newChatSearch.addEventListener('input', searchNewTraders);
            modalCityFilter.addEventListener('input', searchNewTraders);
            modalCountryFilter.addEventListener('input', searchNewTraders);
            modalRoleFilter.addEventListener('change', searchNewTraders);
            
            // Load initial list when modal opens
            document.getElementById('newChatModal').addEventListener('shown.bs.modal', function () {
                searchNewTraders();
            });
        </script>
    }
